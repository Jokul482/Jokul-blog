---
title: 浏览器渲染原理（上）
createTime: 2025/02/8 17:01:33
permalink: /article/jsjlxf7n/
tags:
  - 浏览器
---
**又名：在浏览器输入URL回车之后发生了什么？**

要搞懂浏览器渲染原理，咱得先瞅瞅浏览器。
- Chrome
- Safari
- Edge
- Firefox
- Samsung Internet
- Opera

如今市面上，这六位可算是浏览器界的模范儿！

好，现在咱假设一下，要是某天，你心血来潮，想在网上瞅瞅重庆山城的美景，刷一下`www.baidu.com`。手机掏出来，浏览器打开，网址栏一敲，回车，然后，接下来会发生啥呢？

别急，这个过程其实可复杂啦，要是简化一下的话，大致是这样的几步：

`输入 URL → DNS 解析 → 建立 TCP 连接 → 发送 HTTP 请求 → 服务器响应 → 下载资源 → 解析 HTML → 构建 DOM/CSSOM → 执行 JS → 生成渲染树 → 布局（Layout） → 绘制（Paint）`

乍一看，这每一小步都藏着不少门道。比如，`DNS`、`TCP`、`HTTP`，这些词儿，你是不是觉得挺眼熟，但又不知道它们到底干啥的？还有 `CSSOM` 以及 `渲染树`，这两个词儿更是听得人一脸懵，不知所云。

咱就从第一步开始，慢慢唠唠。

::: tip 说明
2025年1月，[Statcounter Global Stats - Browser](https://gs.statcounter.com/)显示。

**Chrome**一马当先占了 **67.08%**，也难怪现如今搞前端开发的，`Chrome`调试工具几乎成了“必需品”；

**Safari**呢，**17.95%** 的占比，苹果生态的老铁们（大部分要用它）。

**Edge**，占比 **5.2%**。“Chromium系”的一员，拥有强大兼容性和性能。

**Firefox**，占比 **2.54%**。开源界的“大拿”，虽市场份额不高，但在开发者圈里，因其强大的隐私保护和扩展功能，一直有不少拥趸。

**Samsung Internet**，占比**2.24%**。`Samsung Internet` 针对三星手机和平板进行了深度优化。

**Opera**，占比**2.11%**。`Opera` 浏览器以轻量级著称，启动速度快，资源占用低，适合在性能较弱的设备上使用。
:::

## 第一步：输入 URL，浏览器开始DNS解析

_你好奇地问道："当我在浏览器输入网址后，它究竟是如何找到对应网站的呢？"_

_"这就要从互联网的'电话簿'——DNS解析说起了。"_

当你在浏览器输入 `www.baidu.com` 时，浏览器需要借助`DNS`（域名系统）将人类友好的域名转换为机器识别的`IP`地址（如 `14.215.177.38`）。


> ### 为什么需要DNS解析？

- 人类擅长记忆语义化名称（如`www.baidu.com`），而网络设备依赖数字IP地址进行通信。
- IP地址可能变更（服务器迁移/扩容），域名保持不变。
- 负载均衡：一个域名可映射多个IP（如百度实际对应数万台服务器）
- 虚拟主机：通过HTTP头中的Host字段区分同一IP的不同网站

> ### 为什么不用IP直接访问？

- 记忆成本：记住`220.181.38.148`不如`baidu.com`方便  
- 灵活性：IP变更无需用户感知  
- 安全性：DNS支持DNSSEC防劫持，HTTPS确保传输加密


> ### DNS解析的完整流程

1. 浏览器缓存 → 2. 系统缓存 → 3. 路由器缓存 → 4. ISP DNS缓存 → 5. 递归查询
   （若所有缓存未命中，最终会访问根域名服务器→顶级域名服务器→权威域名服务器）
   
▶ 比喻版解释：  
就像找人问路时，先问同桌（浏览器缓存）→ 班长（系统缓存）→ 班主任（路由器）→ 教务处（ISP）→ 最终查到学籍档案室（根域名服务器）

::: tip 总结
DNS 的这一转换过程是浏览器开始渲染页面的第一步，是互联网基础架构中的关键环节，确保了人类能够以直观且高效的方式使用网络资源。
:::

## 第二步：建立 TCP 连接

**TCP（Transmission Control Protocol，传输控制协议）就是一种面向连接的、可靠的、基于字节流的传输层通信协议。建立 TCP 连接，就是通过三次握手建立可靠的连接。**

“也就是说当浏览器完成 `DNS` 解析并获取目标服务器的 IP 地址后，接下来会进入建立 `TCP` 连接的阶段。而建立 `TCP` 连接发生的具体过程，通常称为“三次握手”（**Three-Way Handshake**）”

_“你明白了吗？”我微微一笑道。_

_“嗯，有点懂了。建立 `TCP` 连接会发生三次握手。**那为啥要三次握手呢？不能握一次吗？三次握手成功或者失败又会发生什么呢？**“你不解的问。_

_“我给你简单解释一下。”_

> ### 为什么要进行三次握手？

1. 确保双方都准备好：三次握手确保双方都有收发信息的能力，且都愿意建立连接。
- 第一次握手（SYN）： 客户端发送 `SYN` 给服务器，告诉服务器它想建立连接，并提供一个初始序列号。
- 第二次握手（SYN-ACK）： 服务器收到 `SYN` 后，确认客户端的存在，并且也准备好建立连接，同时提供自己的初始序列号。
- 第三次握手（ACK）： 客户端收到 `SYN-ACK` 后，确认服务器的存在，并且告诉服务器它已经准备好接收数据。

2. 防止无效连接：能避免旧的或重复的连接请求在网络中游荡而建立无效连接，保障通信稳定。
- 三次握手可以防止旧的连接请求数据包意外地建立连接。例如，客户端可能发送了一个 `SYN`，但因为网络延迟或丢包，这个 `SYN` 很久之后才到达服务  器。如果只有一次握手，服务器可能会误以为这是一个新的连接请求，从而建立一个无效的连接。
- 通过三次握手，服务器可以通过确认号`（Ack）`来验证客户端是否是真正想要建立连接的，而不是一个旧的请求。

> ### 不能握一次手吗？

如果只有一次握手，比如客户端发送一个 `SYN`，服务器收到后直接开始发送数据，那么可能会出现以下问题：
- 客户端可能因为网络问题没有收到服务器的响应，导致客户端不知道服务器是否准备好。
- 服务器可能因为网络问题没有收到客户端的 `SYN`，导致服务器不知道客户端是否准备好。

**所以，一次握手无法确认双方的收发能力与连接意愿。**

> ### 三次握手成功或者失败又会发生什么呢？

**成功**
- 连接建立：三次握手成功后，双方进入“已建立”状态，可正常传输数据，进行网页加载等操作。

**失败**
- 超时重传： 若发送方在规定时间内无响应，会重传信号，多次失败则提示“无法连接”。
- 拒绝连接： 服务器因故障或资源不足，发送 `RST` 数据包，告知连接失败。
- 未收到 ACK： 服务器重发 `SYN-ACK` 若仍无回应，释放资源，连接失败。


::: tip 总结
三次握手是 TCP 协议中确保连接可靠性和双方准备状态的重要机制。通过三次握手，可以有效防止无效连接，确保双方都准备好进行数据传输。虽然看起来有些复杂，但这是为了保证网络通信的稳定性和可靠性。
:::

## 第三步：发送 HTTP 请求

_“接下来就要回答你之前问的问题啦”我微笑着给你说。_

> ### 什么是 HTTP 请求？

- `HTTP`（超文本传输协议）是浏览器和服务器之间通信的标准协议。当浏览器需要从服务器获取资源（如网页、图片、`CSS`文件等）时，就会发送 `HTTP` 请求。`HTTP` 请求是一种消息格式，它包含请求行、请求头和请求体。

> ### HTTP 请求的作用?

- **获取资源：** 浏览器通过发送 `HTTP` 请求向服务器请求特定的资源，例如网页的 `HTML` 文件、图片、`JavaScript` 文件或 `CSS` 文件。
- **发送数据：** 用户在浏览器中提交表单（如搜索查询、登录信息等）时，浏览器会通过 `HTTP` 请求将数据发送到服务器。
- **协商和访问控制：** `HTTP` 请求中包含各种头信息，用于协商浏览器和服务器之间的通信参数，例如浏览器支持的压缩格式、语言偏好、请求的资源类型等。同时，服务器可以通过分析请求头来控制对资源的访问，例如限制某些 `IP` 地址或用户代理对特定资源的访问。

“等等，你刚才说 `HTTP` 请求是一种消息格式，它包含请求行、请求头和请求体？”你疑惑的发问。

“这个简单。”我微笑道。

> ### HTTP 请求的结构

一个典型的 HTTP 请求由以下部分组成：
- **请求行：** 包括请求方法（如 `GET、POST、PUT、DELETE` 等）、请求 `URL` 和 `HTTP` 协议版本（如 `HTTP/1.1` 或 `HTTP/2`）。例如：
`GET /index.html HTTP/1.1`
- **请求头：** 包含有关请求的附加信息，如浏览器类型、用户语言、支持的压缩格式等。例如：
```js
Host: www.example.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
Accept-Language: en-US,en;q=0.5
```
- **请求体：** 用于发送数据，如表单数据或上传的文件。对于 GET 请求，请求体通常是空的。

> ### 常用 HTTP 请求方法

- GET： 请求获取指定资源的内容。
- POST： 向服务器提交数据，通常是表单数据或上传的文件。
- PUT： 用于更新或替换指定资源的内容。
- DELETE： 请求删除指定资源。

> ### 浏览器发送 HTTP 请求的过程

**当浏览器需要获取资源时，会通过以下步骤发送 HTTP 请求：**

- 如果需要身份验证，浏览器可能会提示用户输入用户名和密码。
- 浏览器将请求发送到服务器的端口（通常是 80 或 443）。
- 服务器收到请求后，进行处理并返回响应。

::: tip 总结
HTTP 请求是浏览器与服务器之间通信的重要方式，通过 HTTP 请求，浏览器可以获取资源、发送数据、协商访问控制等，确保用户能够顺利地浏览网页和访问网络上的各种内容。
:::

## 第四步：服务器响应

> ### 服务器返回响应报文

**在浏览器发送 HTTP 请求后，服务器会返回一个响应报文。响应报文主要包含以下部分：状态码、响应头和资源内容。**

- 状态码：是一个三位数的代码，用于表示服务器对请求的处理结果。例如：

```text
200 OK：表示请求成功，服务器已成功处理了请求。
404 Not Found：表示请求的资源未找到。
500 Internal Server Error：表示服务器内部错误，无法完成请求。
```

- 响应头：包含了服务器返回的元数据，这些元数据提供了关于响应的各种信息，如：

```text
Content-Type：表示响应的内容类型，例如 text/html 表示 HTML 文档，image/jpeg 表示 JPEG 图像。
Content-Length：表示响应内容的长度。
Cache-Control：用于控制缓存策略，例如 max-age=3600 表示内容在客户端缓存中可以缓存 1 小时。
Date：表示服务器生成响应的时间。
Server：表示服务器的软件名称和版本，例如 Apache/2.4.56。
```

- 资源内容：是服务器返回的实际数据，例如 HTML 文档、CSS 文件、JavaScript 文件或图片等。浏览器会根据响应头中的内容类型信息来解析和处理资源内容，从而渲染网页或更新页面内容。

::: tip 总结
服务器返回HTTP响应报文，其中状态码指示请求处理结果，响应头提供资源元数据，资源内容则是请求的资源本身。
:::

## 第五步：下载资源

> ### 浏览器接收 HTML、CSS、JS、图片等文件

- 当浏览器收到服务器返回的 `HTML` 文件后，会开始解析 `HTML` 内容。
- 在解析过程中，浏览器会发现 `HTML` 中引用了其他资源，如 `CSS` 文件、`JavaScript` 文件、图片等。
- 接下来，浏览器会根据这些资源的 `URL`，再次通过 `HTTP` 请求从服务器下载这些资源。

**具体步骤如下：**

- 解析HTML ：浏览器解析 `HTML` 文件，识别出其中的资源引用，如 `<link>` 标签引用的 `CSS` 文件、`<script>` 标签引用的 `JavaScript` 文件、`<img>` 标签引用的图片等。
- 发起请求 ：对于每个引用的资源，浏览器会再次通过 `HTTP` 请求从服务器下载这些资源。这些请求通常会包含资源的 `URL`、请求方法（如 `GET`）、请求头等信息。
- 接收响应 ：服务器收到请求后，会返回相应的资源文件，包括 `CSS` 文件、`JavaScript` 文件、图片等。响应中会包含状态码、响应头和资源内容。
- 缓存处理 ：浏览器会根据响应头中的缓存控制信息（如 `Cache-Control`）决定是否缓存这些资源。如果资源可以缓存，浏览器会在本地存储这些资源，以便下次访问时可以直接使用缓存，减少网络请求。
- 加载资源 ：浏览器将下载的资源加载到内存中，准备进行后续的渲染操作。例如，`CSS` 文件用于设置页面的样式，`JavaScript` 文件用于实现页面的交互功能，图片用于显示图像内容等。

::: tip 总结
下载资源是浏览器渲染网页的重要步骤之一。通过下载 `HTML`、`CSS`、`JavaScript`、图片等文件，浏览器能够获取到网页所需的所有资源，为后续的解析、构建 DOM 树、执行 `JavaScript`、生成渲染树、布局和绘制等步骤打下基础。
:::